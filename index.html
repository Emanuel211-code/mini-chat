<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Mini Chat</title>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body {
    margin: 0;
    font-family: Arial;
    background: #0f172a;
    color: white;
}
.container {
    max-width: 420px;
    margin: auto;
    padding: 20px;
}
.card {
    background: #1e293b;
    padding: 15px;
    border-radius: 12px;
    margin-top: 20px;
}
input, button {
    width: 100%;
    padding: 10px;
    margin-top: 8px;
    border-radius: 6px;
    border: none;
}
button {
    background: #22c55e;
    font-weight: bold;
    cursor: pointer;
}
button:hover {
    background: #16a34a;
}
#chat { display: none; }

#mensagens {
    height: 240px;
    overflow-y: auto;
    background: #020617;
    padding: 10px;
    border-radius: 8px;
}

.msg {
    margin-bottom: 8px;
    padding: 6px;
    background: #1e293b;
    border-radius: 6px;
}

.hora {
    font-size: 11px;
    color: #94a3b8;
}

.friend {
    background: #334155;
    padding: 6px;
    margin-top: 5px;
    border-radius: 6px;
}
</style>
</head>

<body>

<div class="container">

<div class="card" id="loginCard">
    <h2>Login / Cadastro</h2>
    <input id="nome" placeholder="Nome de usu√°rio">
    <input id="email" placeholder="Email">
    <input id="senha" type="password" placeholder="Senha (m√≠n. 6)">
    <button onclick="entrar()">Entrar</button>
    <button onclick="cadastrar()">Cadastrar</button>
</div>

<div class="card" id="chat">
    <h3 id="userNome"></h3>
    <button onclick="sair()">Sair</button>

    <h4>Amigos</h4>
    <input id="emailAmigo" placeholder="Email do amigo">
    <button onclick="addAmigo()">Adicionar</button>
    <div id="listaAmigos"></div>

    <h4>Chat p√∫blico</h4>
    <div id="mensagens"></div>
    <input id="msg" placeholder="Mensagem">
    <button onclick="enviar()">Enviar</button>
</div>

</div>

<script>
// üî• FIREBASE CONFIG
const firebaseConfig = {
  apiKey: "AIzaSyDdEzkTOfqlh05D_ls0juTNAlALyc8bFxI",
  authDomain: "mini-chat-4c58f.firebaseapp.com",
  databaseURL: "https://mini-chat-4c58f-default-rtdb.firebaseio.com",
  projectId: "mini-chat-4c58f",
  storageBucket: "mini-chat-4c58f.appspot.com",
  messagingSenderId: "541279607046",
  appId: "1:541279607046:web:7fe7064bae40bffe64a687"
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.database();

let uid = "";
let nomeUsuario = "";

// ENTRAR
function entrar() {
  auth.signInWithEmailAndPassword(email.value, senha.value)
    .catch(e => alert(e.message));
}

// CADASTRAR
function cadastrar() {
  if (nome.value === "") {
    alert("Digite um nome de usu√°rio");
    return;
  }

  auth.createUserWithEmailAndPassword(email.value, senha.value)
    .then(res => {
      db.ref("usuarios/" + res.user.uid).set({
        nome: nome.value
      });
    })
    .catch(e => alert(e.message));
}

// USU√ÅRIO LOGADO
auth.onAuthStateChanged(user => {
  if (user) {
    uid = user.uid;
    loginCard.style.display = "none";
    chat.style.display = "block";

    db.ref("usuarios/" + uid).once("value").then(snap => {
      nomeUsuario = snap.val().nome;
      userNome.innerText = "Ol√°, " + nomeUsuario;
    });

    carregarMensagens();
    carregarAmigos();
  }
});

// SAIR
function sair() {
  auth.signOut().then(() => location.reload());
}

// ENVIAR MENSAGEM COM HOR√ÅRIO
function enviar() {
  if (msg.value === "") return;

  const agora = new Date();
  const hora = agora.getHours().toString().padStart(2, "0");
  const minuto = agora.getMinutes().toString().padStart(2, "0");

  db.ref("mensagens").push({
    user: nomeUsuario,
    texto: msg.value,
    hora: `${hora}:${minuto}`
  });

  msg.value = "";
}

// CARREGAR MENSAGENS
function carregarMensagens() {
  mensagens.innerHTML = "";
  db.ref("mensagens").on("child_added", s => {
    let m = s.val();
    mensagens.innerHTML += `
      <div class="msg">
        <b>${m.user}</b>: ${m.texto}
        <div class="hora">${m.hora}</div>
      </div>
    `;
    mensagens.scrollTop = mensagens.scrollHeight;
  });
}

// AMIGOS
function addAmigo() {
  if (emailAmigo.value === "") return;
  db.ref("amigos/" + uid).push(emailAmigo.value);
  emailAmigo.value = "";
}

function carregarAmigos() {
  listaAmigos.innerHTML = "";
  db.ref("amigos/" + uid).on("child_added", s => {
    listaAmigos.innerHTML += `<div class="friend">${s.val()}</div>`;
  });
}
</script>

</body>
</html>
